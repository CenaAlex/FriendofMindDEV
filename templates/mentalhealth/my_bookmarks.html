{% extends 'base.html' %}
{% load static %}

{% block title %}My Bookmarks - Friend of Mind{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">My Bookmarked Resources</h1>
        <p class="text-gray-600">You have {{ total_bookmarks }} bookmarked resource{{ total_bookmarks|pluralize }}</p>
    </div>

    {% if bookmarks %}
    <!-- Bookmarks Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for bookmark in bookmarks %}
        <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-6">
            <!-- Header -->
            <div class="flex justify-between items-start mb-3">
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                    {{ bookmark.resource.get_resource_type_display }}
                </span>
                <span class="text-xs text-gray-500">
                    <i class="far fa-clock"></i> {{ bookmark.created_at|timesince }} ago
                </span>
            </div>

            <!-- Content -->
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
                {{ bookmark.resource.title }}
            </h3>
            <p class="text-sm text-gray-600 mb-3 line-clamp-3">
                {{ bookmark.resource.description|truncatewords:20 }}
            </p>

            <!-- Category -->
            <div class="mb-4">
                <span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">
                    {{ bookmark.resource.category.name }}
                </span>
                {% if bookmark.resource.is_free %}
                <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                    Free
                </span>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <a href="{% url 'mentalhealth:resource_detail' bookmark.resource.id %}" 
                   class="flex-1 px-3 py-2 bg-blue-600 text-white text-center rounded hover:bg-blue-700 text-sm">
                    <i class="fas fa-eye"></i> View
                </a>
                <button onclick="removeBookmark({{ bookmark.resource.id }}, this)" 
                        class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <i class="far fa-bookmark text-gray-300 text-6xl mb-4"></i>
        <h2 class="text-2xl font-semibold text-gray-700 mb-2">No Bookmarks Yet</h2>
        <p class="text-gray-600 mb-6">Start bookmarking resources to access them quickly later!</p>
        <a href="{% url 'mentalhealth:resource_list' %}" 
           class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i class="fas fa-search"></i> Browse Resources
        </a>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="mt-8">
        <a href="{% url 'mentalhealth:resource_list' %}" 
           class="inline-block px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            <i class="fas fa-arrow-left"></i> Back to Resources
        </a>
    </div>
</div>

<script>
// Function to get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function removeBookmark(resourceId, button) {
    if (!confirm('Remove this resource from bookmarks?')) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/resources/bookmark/${resourceId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && !data.bookmarked) {
            // Remove the card with animation
            const card = button.closest('.bg-white');
            card.style.opacity = '0';
            card.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                card.remove();
                // Check if no more bookmarks
                const grid = document.querySelector('.grid');
                if (!grid || !grid.querySelector('.bg-white')) {
                    location.reload();
                }
            }, 300);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove bookmark. Please try again.');
    });
}
</script>
{% endblock %}

